{
  "name": "Converto™ A/B ROI Sync",
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "hour": 9,
              "minute": 0
            }
          ]
        }
      },
      "id": "1",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "https://app.posthog.com/api/event/?event=CTA%20Clicked",
        "responseFormat": "json",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "Bearer YOUR_POSTHOG_KEY"
            }
          ]
        }
      },
      "id": "2",
      "name": "PostHog Fetch",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [500, 200]
    },
    {
      "parameters": {
        "functionCode": "const grouped = {};\nfor (const item of items) {\n  const v = item.json.properties?.variant?.value || 'unknown';\n  grouped[v] = (grouped[v] || 0) + 1;\n}\nreturn Object.keys(grouped).map(k => ({ json: { variant: k, clicks: grouped[k] } }));"
      },
      "id": "3",
      "name": "PostHog Parse",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [700, 200]
    },
    {
      "parameters": {
        "url": "https://plausible.io/api/v1/stats/breakdown?site_id=converto.fi&property=goal:demo-request&period=day",
        "responseFormat": "json",
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "Bearer YOUR_PLAUSIBLE_KEY"
            }
          ]
        }
      },
      "id": "4",
      "name": "Plausible Fetch",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [500, 400]
    },
    {
      "parameters": {
        "functionCode": "const output = [];\nfor (const b of items[0].json.results || []) {\n  output.push({ json: { variant: b.property_value || 'StoryBrand', demos: b.visitors || 0 } });\n}\nreturn output;"
      },
      "id": "5",
      "name": "Plausible Parse",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [700, 400]
    },
    {
      "parameters": {
        "mode": "mergeByKey",
        "propertyName1": "variant",
        "propertyName2": "variant"
      },
      "id": "6",
      "name": "Merge Variants",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "functionCode": "return items.map(i => {\n  const d = i.json;\n  d.conversion = d.clicks > 0 ? +(d.demos / d.clicks * 100).toFixed(1) : 0;\n  return { json: d };\n});"
      },
      "id": "7",
      "name": "Calc Conversion",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "functionCode": "return items.map(i => {\n  const d = i.json;\n  d.RevenuePerLead = 150;\n  d.Visitors = 5000;\n  d.DevHoursCost = 350;\n  d.ΔConvRate = d.variant === 'StoryBrand' ? 0.75 : 0;\n  const roiValue = (d.ΔConvRate * d.RevenuePerLead * d.Visitors) - d.DevHoursCost;\n  const roiPct = d.DevHoursCost > 0 ? ((d.ΔConvRate * d.RevenuePerLead * d.Visitors) / d.DevHoursCost) * 100 : 0;\n  d['ROI €'] = Math.round(roiValue);\n  d['ROI %'] = Math.round(roiPct * 10) / 10;\n  return { json: d };\n});"
      },
      "id": "8",
      "name": "Calc ROI",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1300, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "YOUR_NOTION_DB_ID",
        "propertiesUi": {
          "propertyValues": [
            {
              "name": "Päivä",
              "value": "={{ $json[\"date\"] || new Date().toISOString().split('T')[0] }}"
            },
            {
              "name": "Variantti",
              "value": "={{ $json[\"variant\"] }}"
            },
            {
              "name": "CTA-klikkaukset",
              "value": "={{ $json[\"clicks\"] }}"
            },
            {
              "name": "Demo-pyynnöt",
              "value": "={{ $json[\"demos\"] }}"
            },
            {
              "name": "Konversio %",
              "value": "={{ $json[\"conversion\"] }}"
            },
            {
              "name": "ROI €",
              "value": "={{ $json[\"ROI €\"] }}"
            },
            {
              "name": "ROI %",
              "value": "={{ $json[\"ROI %\"] }}"
            }
          ]
        }
      },
      "id": "9",
      "name": "Notion Update",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1500, 300],
      "credentials": {
        "notionApi": "YOUR_NOTION_CREDENTIAL_NAME"
      }
    }
  ],
  "connections": {
    "1": { "main": [ [ { "node": "2", "type": "main", "index": 0 }, { "node": "4", "type": "main", "index": 0 } ] ] },
    "2": { "main": [ [ { "node": "3", "type": "main", "index": 0 } ] ] },
    "3": { "main": [ [ { "node": "6", "type": "main", "index": 0 } ] ] },
    "4": { "main": [ [ { "node": "5", "type": "main", "index": 0 } ] ] },
    "5": { "main": [ [ { "node": "6", "type": "main", "index": 1 } ] ] },
    "6": { "main": [ [ { "node": "7", "type": "main", "index": 0 } ] ] },
    "7": { "main": [ [ { "node": "8", "type": "main", "index": 0 } ] ] },
    "8": { "main": [ [ { "node": "9", "type": "main", "index": 0 } ] ] }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "converto-ab-roi-sync-20251103"
}
