name: Vercel Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build project
        run: |
          cd frontend
          npm run build
        env:
          NODE_ENV: production

      - name: Check build output
        run: |
          ls -la frontend/.next/

      - name: Deploy to Vercel (with conditional secrets)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -n "$VERCEL_TOKEN" ] && [ -n "$VERCEL_PROJECT_ID" ]; then
            echo "üöÄ Deploying to Vercel with automated deployment..."
            npm install -g vercel@latest
            vercel --prod --token=$VERCEL_TOKEN --yes
          else
            echo "‚ö†Ô∏è Vercel secrets not configured. Manual deployment required."
          fi

      - name: Deployment instructions
        run: |
          echo "üåê CONVERTO BUSINESS OS DEPLOYMENT STATUS"
          echo "=========================================="
          echo ""
          echo "‚úÖ Build completed successfully"
          echo "üîß Manual deployment options:"
          echo ""
          echo "OPTION 1 - Vercel CLI (RECOMMENDED):"
          echo "  cd frontend"
          echo "  npm install -g vercel@latest"
          echo "  vercel login"
          echo "  vercel --prod --yes"
          echo ""
          echo "OPTION 2 - Vercel Dashboard:"
          echo "  URL: https://vercel.com/maxs-projects-149851b4/converto-business-os-quantum-mvp-1"
          echo "  1. Open dashboard"
          echo "  2. Go to Settings ‚Üí Git"
          echo "  3. Ensure GitHub repo is connected"
          echo "  4. Deploy manually"
          echo ""
          echo "OPTION 3 - Wait for auto-deployment:"
          echo "  - Push changes to GitHub main branch"
          echo "  - Vercel will auto-deploy if configured"
          echo ""
          echo "üéØ DEPLOYMENT VERIFICATION:"
          echo "  1. Check https://converto.fi"
          echo "  2. Verify 'Converto Business OS‚Ñ¢ - Automatisoi yrityksesi' appears"
          echo "  3. Confirm NO gamification/AI assistant content"
          echo "  4. Should show Services Overview (OCR, VAT, ChatService, Automation)"
          echo ""
          echo "üìû If issues persist, manual Vercel CLI deployment is required."
