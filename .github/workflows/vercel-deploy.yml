# üöÄ Vercel Pro Deployment - Converto Business OS
name: Deploy to Vercel Pro

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    name: Deploy to Vercel Pro
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build project
        working-directory: ./frontend
        run: npm run build

      - name: Deploy to Vercel Pro
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        continue-on-error: true
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./frontend

      - name: Check Deployment Status
        if: steps.vercel-deploy.outcome != 'success'
        run: |
          echo "‚ùå Vercel deployment failed. Checking alternative deployment method..."
          echo "This might be due to missing secrets or Vercel project configuration."
          echo "Please check:"
          echo "1. VERCEL_TOKEN is set in GitHub Secrets"
          echo "2. VERCEL_ORG_ID is set in GitHub Secrets"
          echo "3. VERCEL_PROJECT_ID is set in GitHub Secrets"
          echo "4. Vercel project exists and is linked to this repository"
          exit 1

      - name: Health Check
        if: steps.vercel-deploy.outcome == 'success'
        run: |
          sleep 15
          DEPLOYMENT_URL="${{ steps.vercel-deploy.outputs.preview-url }}"
          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "‚ö†Ô∏è Deployment URL not available. Skipping health check."
            exit 0
          fi
          echo "Checking health at: $DEPLOYMENT_URL/api/health"
          curl -f --max-time 30 "$DEPLOYMENT_URL/api/health" || echo "‚ö†Ô∏è Health check failed, but deployment may still be processing"

      - name: Deployment Summary
        if: steps.vercel-deploy.outcome == 'success'
        run: |
          echo "üöÄ Deployment successful!"
          echo "üìç URL: ${{ steps.vercel-deploy.outputs.preview-url }}"
          echo "üìä Logs: vercel logs ${{ steps.vercel-deploy.outputs.preview-url }} --follow"

      - name: Log Scanning
        if: steps.vercel-deploy.outcome == 'success'
        run: |
          echo "üìä Fetching deployment logs..."
          DEPLOYMENT_URL="${{ steps.vercel-deploy.outputs.preview-url }}"
          if [ -n "$DEPLOYMENT_URL" ]; then
            vercel logs "$DEPLOYMENT_URL" --limit 50 || echo "Logs not available yet"
          else
            echo "Deployment URL not available"
          fi

      - name: MCP Deployment Notification
        if: steps.vercel-deploy.outcome == 'success'
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: |
          echo "üìß MCP notifications can be sent via:"
          echo "  - Resend: resend_deployment_alert"
          echo "  - Notion: notion_deployment_log"
          echo ""
          echo "Deployment URL: ${{ steps.vercel-deploy.outputs.preview-url }}"
          echo "Status: success"

      - name: Deployment Failure Summary
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo ""
          echo "Common issues:"
          echo "1. Missing Vercel secrets in GitHub:"
          echo "   - VERCEL_TOKEN"
          echo "   - VERCEL_ORG_ID"
          echo "   - VERCEL_PROJECT_ID"
          echo ""
          echo "2. Vercel project not linked to repository"
          echo ""
          echo "3. Build errors (check 'Build project' step)"
          echo ""
          echo "To fix:"
          echo "1. Go to GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "2. Add missing Vercel secrets"
          echo "3. Verify Vercel project exists and is linked"
          echo "4. Check build logs for errors"
